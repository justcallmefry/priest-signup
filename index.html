<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Priest Assignments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom nice-to-haves */
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .loader { border-top-color: #3B82F6; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen bg-gray-100 font-sans text-gray-900 pb-10">

    <header class="bg-blue-600 text-white p-6 shadow-lg rounded-b-3xl">
        <h1 class="text-2xl font-bold tracking-tight">Priest Assignments</h1>
        <p class="text-blue-100 text-sm mt-1">Select a slot to sign up</p>
    </header>

    <main id="app" class="p-4 space-y-6">
        <div id="loading" class="flex justify-center mt-10">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
        </div>

        <div id="slots-container" class="hidden space-y-4"></div>
    </main>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100">
            <div class="p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-2" id="modal-title">Sign Up</h3>
                <p class="text-sm text-gray-500 mb-4" id="modal-subtitle">Confirming for Sacrament Table</p>

                <label class="block text-sm font-medium text-gray-700 mb-1">Select your name</label>
                <select id="name-select" class="block w-full p-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 text-lg">
                    <option value="" disabled selected>Choose...</option>
                    </select>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-3 text-gray-700 font-semibold hover:bg-gray-200 rounded-xl transition">Cancel</button>
                <button onclick="submitSignUp()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-md hover:bg-blue-700 transition">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // PASTE YOUR GOOGLE SCRIPT URL HERE
        const API_URL = 'YOUR_DEPLOYED_WEB_APP_URL_GOES_HERE';

        let assignments = [];
        let namesList = [];
        let currentRow = null;

        // Fetch Data on Load
        async function loadData() {
            const res = await fetch(API_URL);
            const data = await res.json();
            assignments = data.slots;
            namesList = data.names;

            populateNames();
            renderSlots();
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('slots-container').classList.remove('hidden');
        }

        // Group by Date and Render
        function renderSlots() {
            const container = document.getElementById('slots-container');
            container.innerHTML = '';

            // Group By Date Helper
            const grouped = assignments.reduce((acc, curr) => {
                // Formatting date nicely
                const dateStr = new Date(curr.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                if (!acc[dateStr]) acc[dateStr] = [];
                acc[dateStr].push(curr);
                return acc;
            }, {});

            Object.keys(grouped).forEach(date => {
                const group = grouped[date];

                const card = document.createElement('div');
                card.className = 'bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100';

                let html = `<div class="bg-gray-50 px-4 py-2 border-b border-gray-100 font-bold text-gray-500 text-xs uppercase tracking-wider">${date}</div>`;

                group.forEach(slot => {
                    const isTaken = slot.volunteer && slot.volunteer.length > 0;
                    const btnColor = isTaken ? 'text-gray-400 cursor-not-allowed' : 'text-blue-600 font-semibold hover:bg-blue-50';
                    const btnText = isTaken ? slot.volunteer : 'Sign Up';
                    const action = isTaken ? '' : `openModal(${slot.row}, '${slot.assignment}', '${date}')`;

                    html += `
                        <div class="flex items-center justify-between p-4 border-b border-gray-100 last:border-0">
                            <span class="font-medium text-gray-800">${slot.assignment}</span>
                            <button onclick="${action}" class="${btnColor} px-3 py-1 rounded-lg text-sm transition-colors text-right">
                                ${btnText} ${!isTaken ? 'â†’' : ''}
                            </button>
                        </div>
                    `;
                });

                card.innerHTML = html;
                container.appendChild(card);
            });
        }

        // Dropdown Logic
        function populateNames() {
            const select = document.getElementById('name-select');
            namesList.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }

        // Modal Logic
        function openModal(row, task, date) {
            currentRow = row;
            document.getElementById('modal-title').innerText = date;
            document.getElementById('modal-subtitle').innerText = `Signing up for: ${task}`;
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('name-select').value = "";
        }

        async function submitSignUp() {
            const name = document.getElementById('name-select').value;
            if (!name) return alert("Please select a name");

            // Optimistic UI Update (Update local data immediately)
            const slotIndex = assignments.findIndex(s => s.row === currentRow);
            if (slotIndex > -1) assignments[slotIndex].volunteer = name;
            renderSlots();
            closeModal();

            // Send to Backend
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ row: currentRow, name: name })
            });
        }

        loadData();
    </script>
</body>
</html>
